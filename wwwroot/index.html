<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>JoyBox Platform</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <header style="background-image: url('images/header.jpg');">
        <h1>JoyBox Platform</h1>

        <div id="topAuth">
            <a href="/login.html" class="auth-btn">Sign in</a>
            <a href="/register.html" class="auth-btn primary">Sign up</a>
        </div>

    </header>

    <main>
        <section id="uploadSection">
            <h2>Upload a Game</h2>
            <form id="uploadForm">
                <input type="text" id="title" placeholder="Game Title" required>
                <textarea id="description" placeholder="Game Description" rows="3" required></textarea>
                <input type="file" id="zipFile" accept=".zip" required>
                <button type="submit">Upload Game</button>
            </form>
            <div id="uploadError" class="error"></div>
            <div id="uploadSuccess" style="color: #4a90e2; font-weight: bold;"></div>
        </section>

        <section id="gamesSection">
            <h2>Available Games</h2>
            <div id="gamesContainer" class="game-grid"></div>
            <div id="gamesError" class="error"></div>
        </section>
    </main>

    <script>



        async function loadGames() {
            const container = document.getElementById('gamesContainer');
            const errorDiv = document.getElementById('gamesError');
            try {
                const response = await fetch('/api/games');
                if (!response.ok) throw new Error('Failed to fetch games');
                const games = await response.json();

                container.innerHTML = '';

                games.forEach(game => {
                    const card = document.createElement('div');
                    card.className = 'game-card';

                    card.innerHTML = `
                                    <div class="game-title">${game.title}</div>
                                    <div class="game-id">ID: ${game.id}</div>
                                    <div class="game-description">${game.description}</div>
                                    <div class="game-buildpath">Build Path: ${game.buildFolderPath}</div>
                                `;

                    container.appendChild(card);
                });
            } catch (err) {
                console.error(err);
                errorDiv.textContent = 'Failed to load games.';
            }
        }

        async function uploadGame(event) {
            event.preventDefault();

            const title = document.getElementById('title').value;
            const description = document.getElementById('description').value;
            const zipFile = document.getElementById('zipFile').files[0];
            const errorDiv = document.getElementById('uploadError');
            const successDiv = document.getElementById('uploadSuccess');

            errorDiv.textContent = '';
            successDiv.textContent = '';

            if (!title || !description || !zipFile) {
                errorDiv.textContent = 'All fields are required.';
                return;
            }

            const formData = new FormData();
            formData.append('Title', title);
            formData.append('Description', description);
            formData.append('ZipFile', zipFile);

            try {
                const response = await fetch('/api/games/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) throw new Error('Failed to upload game');

                const game = await response.json();
                successDiv.textContent = `Game "${game.title}" uploaded successfully!`;

                // Clear form
                document.getElementById('uploadForm').reset();

                // Reload game list
                loadGames();
            } catch (err) {
                console.error(err);
                errorDiv.textContent = 'Failed to upload game.';
            }
        }

        document.getElementById('uploadForm').addEventListener('submit', uploadGame);

        // Load games on page load
        loadGames();
    </script>

    <script>
        (async () => {
            const res = await fetch("/api/users/me", { credentials: "include" });
            if (!res.ok) return;

            const user = await res.json();

            document.getElementById("topAuth").innerHTML = `
            <span>Hello, <strong>${user.nickname}</strong></span>
            <a href="#" onclick="logout()">Logout</a>
        `;
        })();

        async function logout() {
            await fetch("/api/users/logout", {
                method: "POST",
                credentials: "include"
            });
            location.reload();
        }
    </script>

</body>
</html>
