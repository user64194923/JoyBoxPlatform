<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>JoyBox Platform</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>

    <header style="background-image: url('images/header.jpg');">
        <h1>JoyBox Platform</h1>

        <div id="topAuth">
            <a href="/login.html" class="auth-btn">Sign in</a>
            <a href="/register.html" class="auth-btn primary">Sign up</a>
        </div>
    </header>

    <main>

        <!-- Upload -->
        <section id="uploadSection">
            <h2>Upload a Game</h2>
            <form id="uploadForm">
                <input type="text" id="title" placeholder="Game Title" required>
                <textarea id="description" placeholder="Game Description" rows="3" required></textarea>
                <input type="file" id="zipFile" accept=".zip" required>
                <button type="submit">Upload Game</button>
            </form>

            <div id="uploadError" class="error"></div>
            <div id="uploadSuccess" class="success"></div>
        </section>

        <!-- Games -->
        <section id="gamesSection">
            <h2>Available Games</h2>
            <div id="gamesContainer" class="game-grid"></div>
            <div id="gamesError" class="error"></div>
        </section>

    </main>

    <script>
        async function loadGames() {
            const container = document.getElementById('gamesContainer');
            const errorDiv = document.getElementById('gamesError');

            try {
                const response = await fetch('/api/games');
                if (!response.ok) throw new Error();

                const games = await response.json();
                container.innerHTML = '';

                games.forEach(game => {
                    const card = document.createElement('div');
                    card.className = 'game-card';

                    const iconPath = `${game.buildFolderPath}/icon.png`;

                    card.innerHTML = `
                        <img class="game-icon"
                             src="${iconPath}"
                             onerror="this.src='images/default-game.png'">

                        <div class="game-content">
                            <div class="game-title">${game.title}</div>
                            <div class="game-description">${game.description}</div>

                            <button class="play-btn" onclick="playGame(${game.id})">
                                ▶ Play
                            </button>
                        </div>
                    `;


                    container.appendChild(card);
                });
            } catch {
                errorDiv.textContent = 'Failed to load games.';
            }
        }

        function playGame(id) {
            window.location.href = `/playgame.html?id=${id}`;
        }

        async function uploadGame(e) {
            e.preventDefault();

            const formData = new FormData();
            formData.append('Title', title.value);
            formData.append('Description', description.value);
            formData.append('ZipFile', zipFile.files[0]);

            uploadError.textContent = '';
            uploadSuccess.textContent = '';

            try {
                const res = await fetch('/api/games/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!res.ok) throw new Error();

                const game = await res.json();
                uploadSuccess.textContent = `Game "${game.title}" uploaded successfully!`;
                uploadForm.reset();
                loadGames();
            } catch {
                uploadError.textContent = 'Failed to upload game.';
            }
        }

        uploadForm.addEventListener('submit', uploadGame);
        loadGames();
    </script>

    <script>
        (async () => {
            const res = await fetch("/api/users/me", { credentials: "include" });
            if (!res.ok) return;

            const user = await res.json();
            document.getElementById("topAuth").innerHTML = `
                <span class="welcome">Hello, <strong>${user.nickname}</strong></span>
                <a href="#" class="auth-btn" onclick="logout()">Logout</a>
            `;
        })();

        async function logout() {
            await fetch("/api/users/logout", {
                method: "POST",
                credentials: "include"
            });
            location.reload();
        }
    </script>

</body>
</html>
